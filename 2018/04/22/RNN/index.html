<!DOCTYPE html>
<html style="display: none;" lang="zh">
    <head>
    <meta charset="utf-8">
    <!--
        © Material Theme
        https://github.com/viosey/hexo-theme-material
        Version: 1.5.6 -->
    <script>
        window.materialVersion = "1.5.6"
        // Delete localstorage with these tags
        window.oldVersion = [
            'codestartv1',
            '1.3.4',
            '1.4.0',
            '1.4.0b1',
            '1.5.0',
            '1.5.2',
            '1.5.5'
        ]
    </script>

    <!-- dns prefetch -->
    <meta http-equiv="x-dns-prefetch-control" content="on">






    <link rel="dns-prefetch" href="https://cdn-city.livere.com"/>






    <link rel="dns-prefetch" href="https://fonts.proxy.ustclug.org"/>





    <!-- Meta & Info -->
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!-- Title -->
    
    <title>
        
            循环神经网络RNN | 
        
        Hey~YaHei!
    </title>

    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/img/favicon.png">
    <link rel="icon" href="/img/favicon.png">

    <meta name="format-detection" content="telephone=no"/>
    <meta name="description" itemprop="description" content="">
    <meta name="keywords" content=",《Handson-ML》笔记">
    <meta name="theme-color" content="#0097A7">

    <!-- Disable Fucking Bloody Baidu Tranformation -->
    <meta http-equiv="Cache-Control" content="no-transform" />
    <meta http-equiv="Cache-Control" content="no-siteapp" />

    <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">

        
            <script src="/js/ie-blocker.zhCN.js"></script>
        
    <![endif]-->

    <!-- Import lsloader -->
    <script>(function(){window.lsloader={jsRunSequence:[],jsnamemap:{},cssnamemap:{}};lsloader.removeLS=function(a){try{localStorage.removeItem(a)}catch(b){}};lsloader.setLS=function(a,c){try{localStorage.setItem(a,c)}catch(b){}};lsloader.getLS=function(a){var c="";try{c=localStorage.getItem(a)}catch(b){c=""}return c};versionString="/*"+(window.materialVersion||"unknownVersion")+"*/";lsloader.clean=function(){try{var b=[];for(var a=0;a<localStorage.length;a++){b.push(localStorage.key(a))}b.forEach(function(e){var f=lsloader.getLS(e);if(window.oldVersion){var d=window.oldVersion.reduce(function(g,h){return g||f.indexOf("/*"+h+"*/")!==-1},false);if(d){lsloader.removeLS(e)}}})}catch(c){}};lsloader.clean();lsloader.load=function(f,a,b,d){if(typeof b==="boolean"){d=b;b=undefined}d=d||false;b=b||function(){};var e;e=this.getLS(f);if(e&&e.indexOf(versionString)===-1){this.removeLS(f);this.requestResource(f,a,b,d);return}if(e){var c=e.split(versionString)[0];if(c!=a){console.log("reload:"+a);this.removeLS(f);this.requestResource(f,a,b,d);return}e=e.split(versionString)[1];if(d){this.jsRunSequence.push({name:f,code:e});this.runjs(a,f,e)}else{document.getElementById(f).appendChild(document.createTextNode(e));b()}}else{this.requestResource(f,a,b,d)}};lsloader.requestResource=function(b,e,a,c){var d=this;if(c){this.iojs(e,b,function(h,f,g){d.setLS(f,h+versionString+g);d.runjs(h,f,g)})}else{this.iocss(e,b,function(f){document.getElementById(b).appendChild(document.createTextNode(f));d.setLS(b,e+versionString+f)},a)}};lsloader.iojs=function(d,b,g){var a=this;a.jsRunSequence.push({name:b,code:""});try{var f=new XMLHttpRequest();f.open("get",d,true);f.onreadystatechange=function(){if(f.readyState==4){if((f.status>=200&&f.status<300)||f.status==304){if(f.response!=""){g(d,b,f.response);return}}a.jsfallback(d,b)}};f.send(null)}catch(c){a.jsfallback(d,b)}};lsloader.iocss=function(f,c,h,a){var b=this;try{var g=new XMLHttpRequest();g.open("get",f,true);g.onreadystatechange=function(){if(g.readyState==4){if((g.status>=200&&g.status<300)||g.status==304){if(g.response!=""){h(g.response);a();return}}b.cssfallback(f,c,a)}};g.send(null)}catch(d){b.cssfallback(f,c,a)}};lsloader.iofonts=function(f,c,h,a){var b=this;try{var g=new XMLHttpRequest();g.open("get",f,true);g.onreadystatechange=function(){if(g.readyState==4){if((g.status>=200&&g.status<300)||g.status==304){if(g.response!=""){h(g.response);a();return}}b.cssfallback(f,c,a)}};g.send(null)}catch(d){b.cssfallback(f,c,a)}};lsloader.runjs=function(f,c,e){if(!!c&&!!e){for(var b in this.jsRunSequence){if(this.jsRunSequence[b].name==c){this.jsRunSequence[b].code=e}}}if(!!this.jsRunSequence[0]&&!!this.jsRunSequence[0].code&&this.jsRunSequence[0].status!="failed"){var a=document.createElement("script");a.appendChild(document.createTextNode(this.jsRunSequence[0].code));a.type="text/javascript";document.getElementsByTagName("head")[0].appendChild(a);this.jsRunSequence.shift();if(this.jsRunSequence.length>0){this.runjs()}}else{if(!!this.jsRunSequence[0]&&this.jsRunSequence[0].status=="failed"){var d=this;var a=document.createElement("script");a.src=this.jsRunSequence[0].path;a.type="text/javascript";this.jsRunSequence[0].status="loading";a.onload=function(){d.jsRunSequence.shift();if(d.jsRunSequence.length>0){d.runjs()}};document.body.appendChild(a)}}};lsloader.tagLoad=function(b,a){this.jsRunSequence.push({name:a,code:"",path:b,status:"failed"});this.runjs()};lsloader.jsfallback=function(c,b){if(!!this.jsnamemap[b]){return}else{this.jsnamemap[b]=b}for(var a in this.jsRunSequence){if(this.jsRunSequence[a].name==b){this.jsRunSequence[a].code="";this.jsRunSequence[a].status="failed";this.jsRunSequence[a].path=c}}this.runjs()};lsloader.cssfallback=function(e,c,b){if(!!this.cssnamemap[c]){return}else{this.cssnamemap[c]=1}var d=document.createElement("link");d.type="text/css";d.href=e;d.rel="stylesheet";d.onload=d.onerror=b;var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(d,a)};lsloader.runInlineScript=function(c,b){var a=document.getElementById(b).innerText;this.jsRunSequence.push({name:c,code:a});this.runjs()}})();</script>

    <!-- Import queue -->
    <script>function Queue(){this.dataStore=[];this.offer=b;this.poll=d;this.execNext=a;this.debug=false;this.startDebug=c;function b(e){if(this.debug){console.log("Offered a Queued Function.")}if(typeof e==="function"){this.dataStore.push(e)}else{console.log("You must offer a function.")}}function d(){if(this.debug){console.log("Polled a Queued Function.")}return this.dataStore.shift()}function a(){var e=this.poll();if(e!==undefined){if(this.debug){console.log("Run a Queued Function.")}e()}}function c(){this.debug=true}}var queue=new Queue();</script>

    <!-- Import CSS -->
    
        <style id="material_css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("material_css","/css/material.min.css?Z7a72R1E4SxzBKR/WGctOA==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>
        <style id="style_css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("style_css","/css/style.min.css?NKhlKQkXw/c66TR5p4wO+w==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>

        

    

    

    <!-- Config CSS -->

<!-- Other Styles -->
<style>
  body, html {
    font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
    overflow-x: hidden !important;
  }
  
  code {
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  }

  a {
    color: #00838F;
  }

  .mdl-card__media,
  #search-label,
  #search-form-label:after,
  #scheme-Paradox .hot_tags-count,
  #scheme-Paradox .sidebar_archives-count,
  #scheme-Paradox .sidebar-colored .sidebar-header,
  #scheme-Paradox .sidebar-colored .sidebar-badge{
    background-color: #0097A7 !important;
  }

  /* Sidebar User Drop Down Menu Text Color */
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover,
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus {
    color: #0097A7 !important;
  }

  #post_entry-right-info,
  .sidebar-colored .sidebar-nav li:hover > a,
  .sidebar-colored .sidebar-nav li:hover > a i,
  .sidebar-colored .sidebar-nav li > a:hover,
  .sidebar-colored .sidebar-nav li > a:hover i,
  .sidebar-colored .sidebar-nav li > a:focus i,
  .sidebar-colored .sidebar-nav > .open > a,
  .sidebar-colored .sidebar-nav > .open > a:hover,
  .sidebar-colored .sidebar-nav > .open > a:focus,
  #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a {
    color: #0097A7 !important;
  }

  .toTop {
    background: #757575 !important;
  }

  .material-layout .material-post>.material-nav,
  .material-layout .material-index>.material-nav,
  .material-nav a {
    color: #757575;
  }

  #scheme-Paradox .MD-burger-layer {
    background-color: #757575;
  }

  #scheme-Paradox #post-toc-trigger-btn {
    color: #757575;
  }

  .post-toc a:hover {
    color: #00838F;
    text-decoration: underline;
  }

</style>


<!-- Theme Background Related-->

    <style>
      body{
        background-color: #F5F5F5;
      }

      /* blog_info bottom background */
      #scheme-Paradox .material-layout .something-else .mdl-card__supporting-text{
        background-color: #fff;
      }
    </style>




<!-- Fade Effect -->

    <style>
      .fade {
        transition: all 800ms linear;
        -webkit-transform: translate3d(0,0,0);
        -moz-transform: translate3d(0,0,0);
        -ms-transform: translate3d(0,0,0);
        -o-transform: translate3d(0,0,0);
        transform: translate3d(0,0,0);
        opacity: 1;
      }

      .fade.out{
        opacity: 0;
      }
    </style>


<!-- Import Font -->
<!-- Import Roboto -->

    <link href="https://fonts.proxy.ustclug.org/css?family=Roboto:300,400,500" rel="stylesheet">


<!-- Import Material Icons -->


    <style id="material_icons"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("material_icons","/css/material-icons.css?pqhB/Rd/ab0H2+kZp0RDmw==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>




    <!-- Import jQuery -->
    
        <script>lsloader.load("jq_js","https://cdn.bootcss.com/jquery/2.2.0/jquery.min.js", true)</script>
    

    <!-- WebAPP Icons -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Hey~YaHei!">
    <meta name="msapplication-starturl" content="https://hey-yahei.cn/2018/04/22/RNN/">
    <meta name="msapplication-navbutton-color" content="#0097A7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Hey~YaHei!">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon" href="/img/favicon.png">

    <!-- Site Verification -->
    <meta name="google-site-verification" content="9RYmZ6xORQYm4BISDRGPi57Oj0NzoKAN-U9ZR6UxSxY" />
    <meta name="baidu-site-verification" content="xij8ev3DGx" />

    <!-- RSS -->
    
        
            <link rel=alternate type="application/rss+xml" href="/rss2.xml">
        
    

    <!-- The Open Graph protocol -->
    <meta property="og:url" content="https://hey-yahei.cn/2018/04/22/RNN/">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="循环神经网络RNN | Hey~YaHei!">
    <meta property="og:image" content="/img/favicon.png">
    <meta property="og:description" content="">
    <meta property="og:article:tag" content="《Handson-ML》笔记"> 

    
        <meta property="article:published_time" content="Sun Apr 22 2018 00:00:00 GMT+0800">
        <meta property="article:modified_time" content="Fri Aug 24 2018 12:31:59 GMT+0800">
    

    <!-- The Twitter Card protocol -->
    <meta name="twitter:card" content="summary_large_image">

    <!-- Add canonical link for SEO -->
    
        <link rel="canonical" href="https://hey-yahei.cn/2018/04/22/RNN/index.html" />
    

    <!-- Structured-data for SEO -->
    
        


<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage": "https://hey-yahei.cn/2018/04/22/RNN/index.html",
    "headline": "循环神经网络RNN",
    "datePublished": "Sun Apr 22 2018 00:00:00 GMT+0800",
    "dateModified": "Fri Aug 24 2018 12:31:59 GMT+0800",
    "author": {
        "@type": "Person",
        "name": "YaHei",
        "image": {
            "@type": "ImageObject",
            "url": "/imgs/avatar2.jpg"
        },
        "description": "Hey!"
    },
    "publisher": {
        "@type": "Organization",
        "name": "Hey~YaHei!",
        "logo": {
            "@type":"ImageObject",
            "url": "/img/favicon.png"
        }
    },
    "keywords": ",《Handson-ML》笔记",
    "description": "",
}
</script>


    

    <!-- Analytics -->
    
    
    

    <!-- Custom Head -->
    

<link rel="stylesheet" href="/css/prism.css" type="text/css"></head>


    
        <body id="scheme-Paradox" class="lazy">
            <div class="material-layout  mdl-js-layout has-drawer is-upgraded">
                

                <!-- Main Container -->
                <main class="material-layout__content" id="main">

                    <!-- Top Anchor -->
                    <div id="top"></div>

                    
                        <!-- Hamburger Button -->
                        <button class="MD-burger-icon sidebar-toggle">
                            <span id="MD-burger-id" class="MD-burger-layer"></span>
                        </button>
                    

                    <!-- Post TOC -->

    
    <!-- Back Button -->
    <!--
    <div class="material-back" id="backhome-div" tabindex="0">
        <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"
           href="#" onclick="window.history.back();return false;"
           target="_self"
           role="button"
           data-upgraded=",MaterialButton,MaterialRipple">
            <i class="material-icons" role="presentation">arrow_back</i>
            <span class="mdl-button__ripple-container">
                <span class="mdl-ripple"></span>
            </span>
        </a>
    </div>
    -->


    <!-- Left aligned menu below button -->
    
    
    <button id="post-toc-trigger-btn"
        class="mdl-button mdl-js-button mdl-button--icon">
        <i class="material-icons">format_list_numbered</i>
    </button>

    <ul class="post-toc-wrap mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect" for="post-toc-trigger-btn" style="max-height:80vh; overflow-y:scroll;">
        <ol class="post-toc"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Basic-RNNs的tensorflow实现"><span class="post-toc-number">1.</span> <span class="post-toc-text">Basic RNNs的tensorflow实现</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#训练RNN（BackproPagation-Through-Time-BPTT）"><span class="post-toc-number">2.</span> <span class="post-toc-text">训练RNN（BackproPagation Through Time, BPTT）</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#序列分类器"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">序列分类器</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#预测时间序列"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">预测时间序列</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#深层RNN"><span class="post-toc-number">3.</span> <span class="post-toc-text">深层RNN</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#分布式训练"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">分布式训练</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#使用Dropout"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">使用Dropout</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#长期依赖问题"><span class="post-toc-number">3.3.</span> <span class="post-toc-text">长期依赖问题</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#LSTM"><span class="post-toc-number">4.</span> <span class="post-toc-text">LSTM</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#应用"><span class="post-toc-number">5.</span> <span class="post-toc-text">应用</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#词嵌入"><span class="post-toc-number">5.1.</span> <span class="post-toc-text">词嵌入</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#机器翻译（Encoder-Decoder）"><span class="post-toc-number">5.2.</span> <span class="post-toc-text">机器翻译（Encoder-Decoder）</span></a></li></ol></li></ol>
    </ul>
    




<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">

        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                
    <!-- Paradox Post Header -->
    
        
            <!-- Random Thumbnail -->
            <div class="post_thumbnail-random mdl-card__media mdl-color-text--grey-50">
            <script type="text/ls-javascript" id="post-thumbnail-script">
    var randomNum = Math.floor(Math.random() * 19 + 1);

    $('.post_thumbnail-random').attr('data-original', '/img/random/material-' + randomNum + '.png');
    $('.post_thumbnail-random').addClass('lazy');
</script>

        
    
            <p class="article-headline-p">
                循环神经网络RNN
            </p>
        </div>





                
                    <!-- Paradox Post Info -->
                    <div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">

    <!-- Author Avatar -->
    <div id="author-avatar">
        <img src="/imgs/avatar2.jpg" width="44px" height="44px" alt="Author Avatar"/>
    </div>
    <!-- Author Name & Date -->
    <div>
        <strong>YaHei</strong>
        <span>4月 22, 2018</span>
    </div>

    <div class="section-spacer"></div>

    <!-- Favorite -->
    <!--
        <button id="article-functions-like-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon btn-like">
            <i class="material-icons" role="presentation">favorite</i>
            <span class="visuallyhidden">favorites</span>
        </button>
    -->

    <!-- Qrcode -->
    

    <!-- Tags (bookmark) -->
    
    <button id="article-functions-viewtags-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
        <i class="material-icons" role="presentation">bookmark</i>
        <span class="visuallyhidden">bookmark</span>
    </button>
    <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-viewtags-button">
        <li class="mdl-menu__item">
        <a class="post_tag-link" href="/tags/《Handson-ML》笔记/">《Handson-ML》笔记</a>
    </ul>
    

    <!-- Share -->
    
        <button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">share</i>
    <span class="visuallyhidden">share</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button">
    

    

    <!-- Share Weibo -->
    
        <a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=循环神经网络RNN&url=https://hey-yahei.cn/2018/04/22/RNN/index.html&pic=https://hey-yahei.cn/img/favicon.png&searchPic=false&style=simple" target="_blank">
            <li class="mdl-menu__item">
                分享到微博
            </li>
        </a>
    

    <!-- Share Twitter -->
    

    <!-- Share Facebook -->
    

    <!-- Share Google+ -->
    

    <!-- Share LinkedIn -->
    

    <!-- Share QQ -->
    
        <a class="post_share-link" href="http://connect.qq.com/widget/shareqq/index.html?site=Hey~YaHei!&title=循环神经网络RNN&summary=&pics=https://hey-yahei.cn/img/favicon.png&url=https://hey-yahei.cn/2018/04/22/RNN/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 QQ
            </li>
        </a>
    

    <!-- Share Telegram -->
    
</ul>

    
</div>

                

                <!-- Post Content -->
                <div id="post-content" class="mdl-color-text--grey-700 mdl-card__supporting-text fade out">
    
        <p><iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="298" height="52" src="//music.163.com/outchain/player?type=2&id=30431340&auto=0&height=32"></iframe><br>BGM：<strong>《Aldnoah Zero》ED1</strong><br>歌词混好几种语言       </p>
<hr>
<p>参考<a href="https://book.douban.com/subject/26840215/" target="_blank" rel="noopener">《Hands-On Machine Learning with Scikit-Learn and TensorFlow(2017)》</a>Chap14<br><a href="/2018/04/08/Handson-ML/">《Hands-On Machine Learning with Scikit-Learn and TensorFlow》笔记</a>        </p>
<blockquote>
<p>【占坑待填】<br>Handson ML对RNN的介绍比较简略，先占着坑          </p>
</blockquote>
<h3 id="Basic-RNNs的tensorflow实现"><a href="#Basic-RNNs的tensorflow实现" class="headerlink" title="Basic RNNs的tensorflow实现"></a>Basic RNNs的tensorflow实现</h3><ul>
<li><a href="/Handson-ML/14.1Static_Unrolling_Through_Time(Plain).html">Jupyter - Static Unrolling Through Time(Plain)</a><br>  底层操作实现的静态展开</li>
<li><a href="/Handson-ML/14.2Unrolling_Through_Time(High-level_API).html">Jupyter - Unrolling Through Time(High-level_API)</a><br>  高层操作实现的静态展开和动态展开          </li>
<li><a href="/Handson-ML/14.3Handling_Variable_Length_Sequences.html">Jupyter - Handling Variable Length Sequences</a><br>  处理变长的输入输出，另外还有一种办法，参见<a href="#机器翻译（Encoder-Decoder）">5.2 机器翻译（Encoder-Decoder）</a>       </li>
</ul>
<h3 id="训练RNN（BackproPagation-Through-Time-BPTT）"><a href="#训练RNN（BackproPagation-Through-Time-BPTT）" class="headerlink" title="训练RNN（BackproPagation Through Time, BPTT）"></a>训练RNN（BackproPagation Through Time, BPTT）</h3><p>一般将RNN按时间展开，然后使用常规的反向传播进行训练；<br>如下图所示：      </p>
<p><img src="/Handson-ML/14BPTT.png" alt="BPTT">        </p>
<p>注意这里损失函数 <code>C(·)</code> 是由最后几个输出计算得到的，而不是最后一个输出！      </p>
<h4 id="序列分类器"><a href="#序列分类器" class="headerlink" title="序列分类器"></a>序列分类器</h4><p>类似CNN做MNIST分类器，RNN也可以实现手写数字的识别；<br>按照《Handson-ML》，准确率也可以达到98%以上      </p>
<h4 id="预测时间序列"><a href="#预测时间序列" class="headerlink" title="预测时间序列"></a>预测时间序列</h4><p>比如股价预测——<br>随机截取一些连续的20个时间点的股价作为mini-batch，并且右移1个时间点作为标注；<br>即训练一个预测下一个时间点的股价的模型；<br><img src="/Handson-ML/14Stock_Price_Prediction.png" alt="14Stock_Price_Prediction">       </p>
<p>按前述直接用动态展开的BasicRNNCell组成的RNN网络——    </p>
<pre class=" language-python"><code class="language-python">n_steps <span class="token operator">=</span> <span class="token number">20</span>
n_inputs <span class="token operator">=</span> <span class="token number">1</span>
n_neurons <span class="token operator">=</span> <span class="token number">100</span>
n_outputs <span class="token operator">=</span> <span class="token number">1</span>

X <span class="token operator">=</span> tf<span class="token punctuation">.</span>placeholder<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span> <span class="token punctuation">[</span>None<span class="token punctuation">,</span> n_steps<span class="token punctuation">,</span> n_inputs<span class="token punctuation">]</span><span class="token punctuation">)</span>
y <span class="token operator">=</span> tf<span class="token punctuation">.</span>placeholder<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span> <span class="token punctuation">[</span>None<span class="token punctuation">,</span> n_steps<span class="token punctuation">,</span> n_outputs<span class="token punctuation">]</span><span class="token punctuation">)</span>
cell <span class="token operator">=</span> tf<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>rnn<span class="token punctuation">.</span>BasicRNNCell<span class="token punctuation">(</span>num_units<span class="token operator">=</span>n_neurons<span class="token punctuation">,</span> activation<span class="token operator">=</span>tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>relu<span class="token punctuation">)</span>
outputs<span class="token punctuation">,</span> states <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>dynamic_rnn<span class="token punctuation">(</span>cell<span class="token punctuation">,</span> X<span class="token punctuation">,</span> dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
</code></pre>
<p>但是此时的网络输出outputs是一个包含100元素（<code>n_neurons=100</code>）的向量，<br>而我们需要的只是一个元素，即使下一时刻的预测值，最简单的思路是对cell进行包装：<br>其实就是在BasicRNNCell之后再加一个fully connected层（无激活函数）<br><img src="/Handson-ML/14OutputProjectionWrapper.png" alt="OutputProjectionWrapper">           </p>
<p>具体实现——         </p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># [...]</span>
basic_cell <span class="token operator">=</span> tf<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>rnn<span class="token punctuation">.</span>BasicRNNCell<span class="token punctuation">(</span>num_units<span class="token operator">=</span>n_neurons<span class="token punctuation">,</span> activation<span class="token operator">=</span>tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>relu<span class="token punctuation">)</span>
cell <span class="token operator">=</span> tf<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>rnn<span class="token punctuation">.</span>OutputProjectionWrapper<span class="token punctuation">(</span>basic_cell<span class="token punctuation">,</span> output_size<span class="token operator">=</span>n_outputs<span class="token punctuation">)</span>
outputs<span class="token punctuation">,</span> states <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>dynamic_rnn<span class="token punctuation">(</span>cell<span class="token punctuation">,</span> X<span class="token punctuation">,</span> dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
</code></pre>
<p>此时的outputs就是一个单元素的输出啦~<br>尽管OutputProjectionWrapper可以解决这一问题，但每一步的神经元输出都需要过一层FC，效率不是很高；<br>更好的办法是（只需要过一次FC）：      </p>
<ol>
<li>将RNN的输出从 <code>[batch_size, n_steps, n_neurons]</code> 重整为 <code>[batch_size * n_steps, n_neurons]</code>；        </li>
<li>再通过一个fully connected整合成 <code>[batch_size * n_steps, n_outputs]</code> 大小的输出；        </li>
<li>最后展开成 <code>[batch_size, n_steps, n_outputs]</code> 大小的最终输出<br><img src="/Handson-ML/14More_Efficient_Method.png" alt="14More_Efficient_Method">       </li>
</ol>
<p>具体实现——      </p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># [...]</span>
basic_cell <span class="token operator">=</span> tf<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>rnn<span class="token punctuation">.</span>BasicRNNCell<span class="token punctuation">(</span>num_units<span class="token operator">=</span>n_neurons<span class="token punctuation">,</span> activation<span class="token operator">=</span>tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>relu<span class="token punctuation">)</span>
rnn_outputs<span class="token punctuation">,</span> states <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>dynamic_rnn<span class="token punctuation">(</span>basic_cell<span class="token punctuation">,</span> X<span class="token punctuation">,</span> dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 将RNN的输出从 [batch_size, n_steps, n_neurons] 重整为 [batch_size * n_steps, n_neurons]</span>
stacked_rnn_outputs <span class="token operator">=</span> tf<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>rnn_outputs<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> n_neurons<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># 通过一个fully connected整合成 [batch_size * n_steps, n_outputs] 大小的输出</span>
stacked_outputs <span class="token operator">=</span> fully_connected<span class="token punctuation">(</span>stacked_rnn_outputs<span class="token punctuation">,</span> n_outputs<span class="token punctuation">,</span> activation_fn<span class="token operator">=</span>None<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># 最后展开成 [batch_size, n_steps, n_outputs] 大小的最终输出</span>
outputs <span class="token operator">=</span> tf<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>stacked_outputs<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> n_steps<span class="token punctuation">,</span> n_outputs<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="深层RNN"><a href="#深层RNN" class="headerlink" title="深层RNN"></a>深层RNN</h3><p>直接堆叠RNN就可以得到一个深层的RNN——<br><img src="/Handson-ML/14Deep_RNN.png" alt="14Deep_RNN">         </p>
<p>具体实现——<br>借助 <code>tf.contrib.rnn.MultiRNNCell()</code> 可以将多个RNN堆叠起来       </p>
<pre class=" language-python"><code class="language-python">n_neurons <span class="token operator">=</span> <span class="token number">100</span>
n_layers <span class="token operator">=</span> <span class="token number">3</span>

basic_cell <span class="token operator">=</span> tf<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>rnn<span class="token punctuation">.</span>BasicRNNCell<span class="token punctuation">(</span>num_units<span class="token operator">=</span>n_neurons<span class="token punctuation">)</span>
multi_layer_cell <span class="token operator">=</span> tf<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>rnn<span class="token punctuation">.</span>MultiRNNCell<span class="token punctuation">(</span><span class="token punctuation">[</span>basic_cell<span class="token punctuation">]</span> <span class="token operator">*</span> n_layers<span class="token punctuation">)</span>
outputs<span class="token punctuation">,</span> states <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>dynamic_rnn<span class="token punctuation">(</span>multi_layer_cell<span class="token punctuation">,</span> X<span class="token punctuation">,</span> dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
</code></pre>
<p>此时 <code>states</code> 是一个元组，每个元素都是每一层对应的大小为 <code>[batch_size, n_neurons]</code> 的Tensor；<br>如果为 <code>MultiRNNCell</code> 指定参数 <code>state_is_tuple=False</code> ，那么 <code>states</code> 就只是一个 <code>[batch_size, n_layers * n_neurons]</code> 大小的Tensor；      </p>
<h4 id="分布式训练"><a href="#分布式训练" class="headerlink" title="分布式训练"></a>分布式训练</h4><p><em>……暂略……</em>    </p>
<h4 id="使用Dropout"><a href="#使用Dropout" class="headerlink" title="使用Dropout"></a>使用Dropout</h4><p>如果只是在RNN层之前或者之后，可以直接添加Dropout层【可以参见<a href="/2018/04/11/正则化技术/#dropout">正则化技术 - Dropout</a>】；<br>但如果是在RNN层与RNN层之间添加Dropout，就必须使用 <code>DropoutWrapper</code>：        </p>
<pre class=" language-python"><code class="language-python">keep_prob <span class="token operator">=</span> <span class="token number">0.5</span>

cell <span class="token operator">=</span> tf<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>rnn<span class="token punctuation">.</span>BasicRNNCell<span class="token punctuation">(</span>num_units<span class="token operator">=</span>n_neurons<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># 用DropoutWrapper包装BasicRNNCell</span>
<span class="token comment" spellcheck="true"># ... input_keep_prob参数是输入前dropout层的keep_prob（不指定则步添加dropout）</span>
<span class="token comment" spellcheck="true"># ... 相应的还有output_keep_prob参数</span>
cell_drop <span class="token operator">=</span> tf<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>rnn<span class="token punctuation">.</span>DropoutWrapper<span class="token punctuation">(</span>cell<span class="token punctuation">,</span> input_keep_prob<span class="token operator">=</span>keep_prob<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># 直接堆叠若干个RNN层，层与层之间不能直接使用Dropout层</span>
multi_layer_cell <span class="token operator">=</span> tf<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>rnn<span class="token punctuation">.</span>MultiRNNCell<span class="token punctuation">(</span><span class="token punctuation">[</span>cell_drop<span class="token punctuation">]</span> <span class="token operator">*</span> n_layers<span class="token punctuation">)</span>
rnn_outputs<span class="token punctuation">,</span> states <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>dynamic_rnn<span class="token punctuation">(</span>multi_layer_cell<span class="token punctuation">,</span> X<span class="token punctuation">,</span> dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
</code></pre>
<p>然而头疼的是，<code>DropoutWrapper</code> 并不支持 <code>is_training</code> 参数，也就是说，它在预测是依旧存在dropout层；<br>解决方法有两种——      </p>
<ol>
<li>自己重写一个支持 <code>is_training</code> 参数的 <code>DropoutWrapper</code> 类（<em>什么鬼设定</em>）</li>
<li><p>针对训练和预测构建不同的计算图，具体如下：        </p>
<pre class=" language-python"><code class="language-python"> <span class="token keyword">import</span> sys
 is_training <span class="token operator">=</span> <span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"train"</span><span class="token punctuation">)</span>

 X <span class="token operator">=</span> tf<span class="token punctuation">.</span>placeholder<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span> <span class="token punctuation">[</span>None<span class="token punctuation">,</span> n_steps<span class="token punctuation">,</span> n_inputs<span class="token punctuation">]</span><span class="token punctuation">)</span>
 y <span class="token operator">=</span> tf<span class="token punctuation">.</span>placeholder<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span> <span class="token punctuation">[</span>None<span class="token punctuation">,</span> n_steps<span class="token punctuation">,</span> n_outputs<span class="token punctuation">]</span><span class="token punctuation">)</span>

 cell <span class="token operator">=</span> tf<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>rnn<span class="token punctuation">.</span>BasicRNNCell<span class="token punctuation">(</span>num_units<span class="token operator">=</span>n_neurons<span class="token punctuation">)</span>
 <span class="token keyword">if</span> is_training<span class="token punctuation">:</span>     <span class="token comment" spellcheck="true"># 如果是训练，则用DropoutWrapper包装；如果是预测就拉倒</span>
     cell <span class="token operator">=</span> tf<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>rnn<span class="token punctuation">.</span>DropoutWrapper<span class="token punctuation">(</span>cell<span class="token punctuation">,</span> input_keep_prob<span class="token operator">=</span>keep_prob<span class="token punctuation">)</span>
 multi_layer_cell <span class="token operator">=</span> tf<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>rnn<span class="token punctuation">.</span>MultiRNNCell<span class="token punctuation">(</span><span class="token punctuation">[</span>cell<span class="token punctuation">]</span> <span class="token operator">*</span> n_layers<span class="token punctuation">)</span>
 rnn_outputs<span class="token punctuation">,</span> states <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>dynamic_rnn<span class="token punctuation">(</span>multi_layer_cell<span class="token punctuation">,</span> X<span class="token punctuation">,</span> dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
 <span class="token comment" spellcheck="true"># [...] build the rest of the graph</span>
 init <span class="token operator">=</span> tf<span class="token punctuation">.</span>global_variables_initializer<span class="token punctuation">(</span><span class="token punctuation">)</span>
 saver <span class="token operator">=</span> tf<span class="token punctuation">.</span>train<span class="token punctuation">.</span>Saver<span class="token punctuation">(</span><span class="token punctuation">)</span>

 <span class="token keyword">with</span> tf<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sess<span class="token punctuation">:</span>
     <span class="token keyword">if</span> is_training<span class="token punctuation">:</span>     <span class="token comment" spellcheck="true"># 如果是训练，那就执行初始化器并进行训练</span>
         init<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>
         <span class="token keyword">for</span> iteration <span class="token keyword">in</span> range<span class="token punctuation">(</span>n_iterations<span class="token punctuation">)</span><span class="token punctuation">:</span>
             <span class="token comment" spellcheck="true"># [...] # train the model</span>
             save_path <span class="token operator">=</span> saver<span class="token punctuation">.</span>save<span class="token punctuation">(</span>sess<span class="token punctuation">,</span> <span class="token string">"/tmp/my_model.ckpt"</span><span class="token punctuation">)</span>
     <span class="token keyword">else</span><span class="token punctuation">:</span>   <span class="token comment" spellcheck="true"># 如果是预测，那就直接载入模型并使用</span>
         saver<span class="token punctuation">.</span>restore<span class="token punctuation">(</span>sess<span class="token punctuation">,</span> <span class="token string">"/tmp/my_model.ckpt"</span><span class="token punctuation">)</span>
         <span class="token comment" spellcheck="true"># [...] # use the model</span>
</code></pre>
</li>
</ol>
<h4 id="长期依赖问题"><a href="#长期依赖问题" class="headerlink" title="长期依赖问题"></a>长期依赖问题</h4><p><a href="/2018/04/08/梯度消失与梯度爆炸/">梯度消失与梯度爆炸</a> 所述技术对RNN也是有效的；<br>但是使用这些技术之后，随着时间步增多，训练将变得十分缓慢；<br>最简单粗暴的解决方法是<strong>缩短时间步</strong>，但如此一来RNN忽略比较遥远的过去，也即存在长期依赖的问题；<br>为了解决这一问题，LSTM出现啦！       </p>
<h3 id="LSTM"><a href="#LSTM" class="headerlink" title="LSTM"></a>LSTM</h3><p>论文：<br>【起源】：<a href="https://www.mitpressjournals.org/doi/abs/10.1162/neco.1997.9.8.1735#.WIxuWvErJnw" target="_blank" rel="noopener">Long Short-Term Memory(2006)</a><br>【改进】：       </p>
<ol>
<li><a href="https://arxiv.org/pdf/1402.1128.pdf" target="_blank" rel="noopener">LONG SHORT-TERM MEMORY BASED RECURRENT NEURAL NETWORK ARCHITECTURES FOR LARGE VOCABULARY SPEECH RECOGNITION(2014)</a>        </li>
<li><a href="https://arxiv.org/pdf/1409.2329v5.pdf" target="_blank" rel="noopener">RECURRENT NEURAL NETWORK REGULARIZATION(2015)</a>       </li>
<li><a href="ftp://ftp.idsia.ch/pub/juergen/TimeCount-IJCNN2000.pdf" target="_blank" rel="noopener">Recurrent Nets that Time and Count(2000)</a> 【提出peephole connection】      </li>
<li><a href="https://arxiv.org/pdf/1406.1078v3.pdf" target="_blank" rel="noopener">Learning Phrase Representations using RNN Encoder–Decoder for Statistical Machine Translation(2014)</a> 【提出GRU和Encoder-Decoder架构】<br>其他：<a href="http://colah.github.io/posts/2015-08-Understanding-LSTMs/" target="_blank" rel="noopener">Understanding LSTM Networks(2015)</a>      </li>
</ol>
<p>tensorflow中的使用：<br>直接将先前的 <code>tf.contrib.rnn.BasicRNNCell</code> 替换为 <code>tf.contrib.rnn.BasicLSTMCell</code> 即可；<br>区别在于，<code>BasicLSTMCell</code> 的states包含两个向量，如果要合并在一起的话可以指定参数 <code>state_is_tuple=False</code>；<br>如果要使用变种的LSTM，则使用 <code>tf.contrib.rnn.LSTMCell</code>：<br>比如使用带peephole connection的LSTM，则指定参数 <code>use_peepholes=True</code>          </p>
<pre class=" language-python"><code class="language-python">tf<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>rnn<span class="token punctuation">.</span>LSTMCell<span class="token punctuation">(</span>num_units<span class="token operator">=</span>n_neurons<span class="token punctuation">,</span> use_peepholes<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h3><p><a href="http://karpathy.github.io/2015/05/21/rnn-effectiveness/" target="_blank" rel="noopener">The Unreasonable Effectiveness of Recurrent Neural Networks(2015)</a> 一问介绍了RNN的一些应用；   </p>
<p>接下来只介绍RNN在自然语言处理（NLP）上的两个应用</p>
<h4 id="词嵌入"><a href="#词嵌入" class="headerlink" title="词嵌入"></a>词嵌入</h4><p>参考：</p>
<ol>
<li><a href="https://www.tensorflow.org/tutorials/word2vec" target="_blank" rel="noopener">Tensorflow Tutorial - Word2Vec</a> 或 中文的<a href="http://wiki.jikexueyuan.com/project/tensorflow-zh/tutorials/word2vec.html" target="_blank" rel="noopener">字词的向量表示</a>   </li>
<li><a href="http://colah.github.io/posts/2014-07-NLP-RNNs-Representations/" target="_blank" rel="noopener">Deep Learning, NLP, and Representations(2014)</a>      </li>
<li><a href="http://ruder.io/word-embeddings-2017/" target="_blank" rel="noopener">Word Embeddings in 2017: Trends and future directions(2017)</a>  </li>
</ol>
<p>词表示的方式：       </p>
<ol>
<li>独热码：稀疏表示    </li>
<li>顺序编码：稠密表示          </li>
<li>词嵌入：前两者的折中，而且可以通过训练，使得两个词的距离表示它们的相似程度      </li>
</ol>
<p>tensorflow实现：    </p>
<pre class=" language-python"><code class="language-python">vocabulary_size <span class="token operator">=</span> <span class="token number">50000</span>
embedding_size <span class="token operator">=</span> <span class="token number">150</span>

<span class="token comment" spellcheck="true"># 创建一个待训练的词向量变量</span>
embeddings <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span> tf<span class="token punctuation">.</span>random_uniform<span class="token punctuation">(</span><span class="token punctuation">[</span>vocabulary_size<span class="token punctuation">,</span> embedding_size<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># 占位符，输入单词的顺序编码</span>
train_inputs <span class="token operator">=</span> tf<span class="token punctuation">.</span>placeholder<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>int32<span class="token punctuation">,</span> shape<span class="token operator">=</span><span class="token punctuation">[</span>None<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># 用embedding_lookup获取对应单词的顺序编码对应的词向量表示</span>
embed <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>embedding_lookup<span class="token punctuation">(</span>embeddings<span class="token punctuation">,</span> train_inputs<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># [...] 投喂语料库训练出合适的词向量</span>
<span class="token comment" spellcheck="true"># 投喂前需要预处理语料库，比如将一些未知的单词都置为&lt;UNK>、将链接都置为&lt;URL></span>
</code></pre>
<p>当然，也可以直接下载已经训练好的词向量载入给 <code>embedding</code> 然后直接使用；      </p>
<h4 id="机器翻译（Encoder-Decoder）"><a href="#机器翻译（Encoder-Decoder）" class="headerlink" title="机器翻译（Encoder-Decoder）"></a>机器翻译（Encoder-Decoder）</h4><p>参考：<a href="https://www.tensorflow.org/tutorials/seq2seq" target="_blank" rel="noopener">Tensorflow Tutorial - Seq2Seq</a> 【<a href="https://github.com/google/seq2seq" target="_blank" rel="noopener">代码</a>】    </p>
<p>训练时：<br><img src="/Handson-ML/14Translate.png" alt="14Translate">    </p>
<ul>
<li>源语句投喂给Encoder，注意应该使第一个单词最先进入Decoder      </li>
<li>目标语句投喂给Decoder     </li>
<li>Decoder对每个时间步产生一个评分并交由Softmax层得到单词的输出概率      </li>
</ul>
<p>预测时：<br><img src="/Handson-ML/14Translate_Inference.png" alt="14Translate_Inference">     </p>
<p>Google - Seq2Seq项目的特别之处：     </p>
<ol>
<li>独特的处理变长序列的方式<br> 前述提到用 <strong>sequence_length参数+静态展开</strong> 或 <strong>动态展开</strong> 的方式来处理变长序列；<br> 而Seq2Seq采用另一种方式——<br> 先将语句根据不同长度段分别放入不同的桶中（比如有接收长度为1~6的语句桶、接收长度为7~12的语句桶）；<br> 再用符号 <code>&lt;pad&gt;</code> 将桶内的语句填充到同一规格（比如<code>I drink milk &lt;eos&gt;</code>被填充为<code>I drink milk &lt;eos&gt; &lt;pad&gt; &lt;pad&gt;</code>）；<br> （注意，源语句在前面填充符号，目标语句在末尾填充符号）<br> 然后用一个 <code>target_weights</code> 向量表征每个单词的权重（比如<code>I drink milk &lt;eos&gt; &lt;pad&gt; &lt;pad&gt;</code>的权重为<code>[1,1,1,1,0,0]</code>）；<br> 这样，当损失函数与 <code>target_weights</code> 向量相乘时，<code>&lt;pad&gt;</code> 就被忽略了；      </li>
<li>使用<strong>Sampled Softmax</strong>技术<br> 论文：<a href="https://arxiv.org/pdf/1412.2007v2.pdf" target="_blank" rel="noopener">On Using Very Large Target Vocabulary for Neural Machine Translation</a><br> 当输出字典非常大（比如50000）时，Decoder将产生50000维的向量，使得计算softmax函数时变得非常复杂；<br> 为了避免这个问题，可以使Decoder输出小得多的向量（如1000维），然后用采样技术来评估损失；<br> 这在tensorflow中可以借助函数 <code>sampled_softmax_loss()</code> 实现    </li>
<li>使用注意力机制<br> 论文：<a href="https://arxiv.org/pdf/1502.03044v2.pdf" target="_blank" rel="noopener">Show, Attend and Tell: Neural Image Caption Generation with Visual Attention</a>    </li>
<li>Seq2Seq使用了 <code>tf.nn.legacy_seq2seq</code> 模块，模块中包含了各种各样的Encoder-Decoder模型<br> 比如 <code>embedding_rnn_seq2seq()</code> 函数创建一个与前述机器翻译训练时的图中相同的模型       </li>
</ol>

        
    

    
</div>


                

                <!-- Post Comments -->
                
                    
    <!-- 使用 来必力 -->
<div id="livere-comment">
    <div id="lv-container" data-id="city" data-uid="MTAyMC8zOTE5OS8xNTcyNg==">
	<script type="text/ls-javascript" id="livere-comment-js">
   (function(d, s) {
       var j, e = d.getElementsByTagName(s)[0];
       if (typeof LivereTower === 'function') { return; }
       j = d.createElement(s);
       j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
       j.async = true;
       e.parentNode.insertBefore(j, e);
   })(document, 'script');
	</script>
</div>
</div>
<style>
    #livere-comment{
        background-color: #eee;
        padding: 2pc;
    }
</style>

                
            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    <!-- Prev Nav -->
    
        <a href="/2018/04/25/autoencoder/" id="post_nav-newer" class="prev-content">
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_back</i>
            </button>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            新篇
        </a>
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
        <a href="/2018/04/18/CNN/" id="post_nav-older" class="next-content">
            旧篇
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>

        </div>
    </div>



                    
                        <!-- Overlay For Active Sidebar -->
<div class="sidebar-overlay"></div>

<!-- Material sidebar -->
<aside id="sidebar" class="sidebar sidebar-colored sidebar-fixed-left" role="navigation">
    <div id="sidebar-main">
        <!-- Sidebar Header -->
        <div class="sidebar-header header-cover" style="background-image: url(/img/sidebar_header.png);">
    <!-- Top bar -->
    <div class="top-bar"></div>

    <!-- Sidebar toggle button -->
    <button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display: initial;" data-upgraded=",MaterialButton,MaterialRipple">
        <i class="material-icons">clear_all</i>
        <span class="mdl-button__ripple-container">
            <span class="mdl-ripple">
            </span>
        </span>
    </button>

    <!-- Sidebar Avatar -->
    <div class="sidebar-image">
        <img src="/imgs/avatar2.jpg" alt="YaHei's avatar">
    </div>

    <!-- Sidebar Email -->
    <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
        hey.yahei.zk@gamil.com
        <b class="caret"></b>
    </a>
</div>


        <!-- Sidebar Navigation  -->
        <ul class="nav sidebar-nav">
    <!-- User dropdown  -->
    <li class="dropdown">
        <ul id="settings-dropdown" class="dropdown-menu">
            
                <li>
                    <a href="mailto: hey.yahei.zk@gamil.com" target="_blank" title="Email Me">
                        
                            <i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i>
                        
                        Email Me
                    </a>
                </li>
            
                <li>
                    <a href="http://music.163.com/#/user/home?id=421946266" target="_blank" title="Netease Cloud Music">
                        
                            <i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">music_note</i>
                        
                        Netease Cloud Music
                    </a>
                </li>
            
        </ul>
    </li>

    <!-- Homepage -->
    
        <li id="sidebar-first-li">
            <a href="/">
                
                    <i class="material-icons sidebar-material-icons">home</i>
                
                主页
            </a>
        </li>
        
    

    <!-- Archives  -->
    

    <!-- Categories  -->
    

    <!-- Pages  -->
    
        <li>
            <a href="/tags" title="标签云">
                
                    <i class="material-icons sidebar-material-icons">cloud</i>
                
                标签云
            </a>
        </li>
        
    
        <li>
            <a href="/timeline" title="时间轴">
                
                    <i class="material-icons sidebar-material-icons">event_note</i>
                
                时间轴
            </a>
        </li>
        
    

    <!-- Article Number  -->
    
        <li>
            <a href="/archives">
                文章总数
                <span class="sidebar-badge">50</span>
            </a>
        </li>
        
    
</ul>


        <!-- Sidebar Footer -->
        <!--
I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright, I will thank you so much.
If you still want to delete the copyrights, could you still retain the first one? Which namely "Theme Material"
It will not impact the appearance and can give developers a lot of support :)

很高兴您使用并喜欢该主题，开发不易 十分谢谢与希望您可以保留一下版权声明。
如果您仍然想删除的话 能否只保留第一项呢？即 "Theme Material"
它不会影响美观并可以给开发者很大的支持和动力。 :)
-->

<!-- Sidebar Divider -->

    <div class="sidebar-divider"></div>


<!-- Theme Material -->

    <a href="https://github.com/viosey/hexo-theme-material"  class="sidebar-footer-text-a" target="_blank">
        <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
            主题 - Material
            <span class="sidebar-badge badge-circle">i</span>
        </div>
    </a>


<!-- Help & Support -->
<!--

-->

<!-- Feedback -->
<!--

-->

<!-- About Theme -->
<!--

-->

    </div>

    <!-- Sidebar Image -->
    

</aside>

                    

                    
                        <!-- Footer Top Button -->
                        <div id="back-to-top" class="toTop-wrap">
    <a href="#top" class="toTop">
        <i class="material-icons footer_top-i">expand_less</i>
    </a>
</div>

                    

                    <!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
    
        <!-- Paradox Footer Left Section -->
        <div class="mdl-mini-footer--left-section sns-list">
    <!-- Twitter -->
    

    <!-- Facebook -->
    

    <!-- Google + -->
    

    <!-- Weibo -->
    

    <!-- Instagram -->
    

    <!-- Tumblr -->
    

    <!-- Github -->
    
        <a href="https://github.com/hey-yahei" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-github">
                <span class="visuallyhidden">Github</span>
            </button><!--
     --></a>
    

    <!-- LinkedIn -->
    

    <!-- Zhihu -->
    

    <!-- Bilibili -->
    

    <!-- Telegram -->
    

    <!-- V2EX -->
    

    <!-- Segmentfault -->
    
</div>


        <!--Copyright-->
        <div id="copyright">
            Copyright&nbsp;©&nbsp;<span year></span>&nbsp;Hey~YaHei!
            
                <br>
                
                    <a href="http://www.miitbeian.gov.cn" rel="nofollow">浙ICP备17042598号-1</a>
                
            
        </div>

        <!-- Paradox Footer Right Section -->

        <!--
        I am glad you use this theme, the development is no so easy, I hope you can keep the copyright.
        It will not impact the appearance and can give developers a lot of support :)

        很高兴您使用该主题，开发不易，希望您可以保留一下版权声明。
        它不会影响美观并可以给开发者很大的支持。 :)
        -->

        <div class="mdl-mini-footer--right-section">
            <div>
                <div class="footer-develop-div">Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a">Hexo</a></div>
                <div class="footer-develop-div">Theme - <a href="https://github.com/viosey/hexo-theme-material" target="_blank" class="footer-develop-a">Material</a></div>
            </div>
        </div>
    
</footer>


                    <!-- Import JS File -->

    <script>lsloader.load("lazyload_js","/js/lazyload.min.js?1BcfzuNXqV+ntF6gq+5X3Q==", true)</script>



    <script>lsloader.load("js_js","/js/js.min.js?Bn9UzEm8RrBSxqyZB0zPjA==", true)</script>



    <script>lsloader.load("np_js","/js/nprogress.js?pl3Qhb9lvqR1FlyLUna1Yw==", true)</script>


<script type="text/ls-javascript" id="NProgress-script">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    $('#nprogress .bar').css({
        'background': '#29d'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #29d, 0 0 15px #29d'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#29d',
        'border-left-color': '#29d'
    });
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>



    
        <script>lsloader.load("sm_js","/js/smoothscroll.js?lOy/ACj5suSNi7ZVFVbpFQ==", true)</script>
    







   





<!-- UC Browser Compatible -->
<script>
	var agent = navigator.userAgent.toLowerCase();
	if(agent.indexOf('ucbrowser')>0) {
		document.write('<link rel="stylesheet" href="/css/uc.css">');
	   alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
	}
</script>

<!-- Import prettify js  -->



<!-- Window Load -->
<!-- add class for prettify -->
<script type="text/ls-javascript" id="window-load">
    $(window).on('load', function() {
        // Post_Toc parent position fixed
        $('.post-toc-wrap').parent('.mdl-menu__container').css('position', 'fixed');
    });

    
    
</script>

<!-- MathJax Load-->

    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({"HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"], linebreaks: { automatic:true }, EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50) },
        tex2jax: { inlineMath: [ ["$", "$"], ["\\(","\\)"] ], processEscapes: true, ignoreClass: "tex2jax_ignore|dno",skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']},
        TeX: {  noUndefined: { attributes: { mathcolor: "red", mathbackground: "#FFEEEE", mathsize: "90%" } }, Macros: { href: "{}" } },
        messageStyle: "none"
    });
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

    <script src="https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>




<!-- Bing Background -->


<script type="text/ls-javascript" id="lazy-load">
    // Offer LazyLoad
    queue.offer(function(){
        $('.lazy').lazyload({
            effect : 'show'
        });
    });

    // Start Queue
    $(document).ready(function(){
        setInterval(function(){
            queue.execNext();
        },200);
    });
</script>

<!-- Custom Footer -->



<script>
    var copyrightNow = new Date().getFullYear();
    var textContent = document.querySelector('span[year]')

    copyrightSince = 2017;
    if (copyrightSince === copyrightNow||copyrightSince === 0000) {
        textContent.textContent = copyrightNow
    } else {
        textContent.textContent = copyrightSince + ' - ' + copyrightNow
    }

    (function(){
        var scriptList = document.querySelectorAll('script[type="text/ls-javascript"]')

        for (var i = 0; i < scriptList.length; ++i) {
            var item = scriptList[i];
            lsloader.runInlineScript(item.id,item.id);
        }
    })()
console.log('\n %c © Material Theme | Version: 1.5.6 | https://github.com/viosey/hexo-theme-material %c \n', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-left-radius:5px;border-bottom-left-radius:5px;', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-right-radius:5px;border-bottom-right-radius:5px;');
</script>

                </main>
            </div>
        </body>
    
</html>

<script type="text/javascript">
    var aTagArr = [].slice.apply(document.getElementsByTagName("a"));
    aTagArr.forEach(function (e, i) {
        if( e.href.lastIndexOf("_blank") > -1 ){
            e.target = "_blank";
            e.href = e.href.replace("?_blank", "");
        }
    });
</script>